defmodule Sutra.Cardano.Transaction.TxBuilder.AttachDatumTest do
  @moduledoc false

  use ExUnit.Case, async: true

  @datums_1 [
    "D8799FD8799F58208FC8DBFB03B1ECEF4E63A7C81BC4AE83591E586D1B84A2DF5E59736A87F854F100FF1B0000019B2A39385318A040D8799FD8799F581CEBC770AF2D1CCD3BD318B12710C90E209BB01E18D92E57C43F1283F6FFD8799FD8799FD8799F581CD39E48A70839F6A98D997374365C2BFB1FD83D435D7C87F966660AA4FFFFFFFFFF",
    "D8799FD8799F58208FC8DBFB03B1ECEF4E63A7C81BC4AE83591E586D1B84A2DF5E59736A87F854F100FF1B0000019B2A39385319012C40D8799FD8799F581C377DAD67735DBF0CC405409A9FEA3E1DA2965D5AB3A9B3B4B9A19F38FFD8799FD8799FD8799F581CDDA806926FC8D5F0237819174A39BC6A38E329DAC743671E052BEFB7FFFFFFFFFF"
  ]

  @datum_2 [
    "9F9F582077C665C81810E18FDB5FAE4EF60851488E1B5C4E1E9DB490FD1AE3198127E7165840C55C4F44366F69B1DE325C6E2125FFF78C6C91060DBBEA4688A4514B275F9A5E10092C9C6849DD9951E3DB905389E0666BB880613B2B5D57BCEA40EC2A590705FF9F58203176D0881A62326CA3B7E61335AA8953CEB2ACD0A9CB4CACDCCCB9B3C89B8986584075510A1E32F9D597AB354DDABA1955EA3A5B23F4D19AEB9189F1CE841F47461C86F451CF4C3C17F34333160A5E000E1C40B143241BDC2D28BACB2C29865F820AFF9F5820D67A7592A0297F6C48307D9EA568369F22B06CDEFC818B1949117C54A0A0FBBB5840C1D8062A15C555C7B4BD2AA288F56EB905236105E7145C5658B072076535B221CBFC96109601756E0C8D526EA1B24AB9E97EE1F455FC867B4CD653E3131B9404FFFF",
    "9F9F582077C665C81810E18FDB5FAE4EF60851488E1B5C4E1E9DB490FD1AE3198127E7165840E3583932F7355E29AA3E385CC54C3FA548AAAFFE574E3B5195E955999496174ACFB17E9488A4C44FBCC87A25EEBABCB2BAD9D1BD288909AD16A841B996B7D90AFF9F58203176D0881A62326CA3B7E61335AA8953CEB2ACD0A9CB4CACDCCCB9B3C89B8986584049368F49421025EAFD239FF4094F72235DE32BBD48D5931AB99CC140E48F2398BFA5A402667A24634F212B8F287507618FE05384015EB45CDB324D65533CCA0BFF9F5820D67A7592A0297F6C48307D9EA568369F22B06CDEFC818B1949117C54A0A0FBBB5840538C080C9630EB74A8EDBE5C12316B24B1284E950775B632F68E79D4FACB097664A641B92378E92D23850FC2DDF15D6EB8D39C23445D861D2695EC0346F44409FFFF"
  ]

  alias Sutra.Cardano.Address
  alias Sutra.Cardano.Transaction
  alias Sutra.Cardano.Transaction.TxBuilder
  alias Sutra.Data
  alias Sutra.SlotConfig
  import Sutra.Test.Support.BuilderSupport

  describe "attach_datum" do
    defp attach_multi_datums(%TxBuilder{} = tx, datums) do
      Enum.reduce(datums, tx, fn datum, acc_tx ->
        decoded_datum = Data.decode!(datum)
        TxBuilder.attach_datum(acc_tx, decoded_datum)
      end)
    end

    test "attaches multiple datums to the transaction" do
      assert {:ok, %Transaction{}} =
               TxBuilder.new_tx()
               |> attach_multi_datums(@datums_1)
               |> attach_multi_datums(@datum_2)
               |> TxBuilder.set_protocol_params(sample_protocol_params())
               |> TxBuilder.use_provider(Sutra.Provider.Koios)
               |> TxBuilder.set_wallet_address([Address.from_bech32(sample_address())])
               |> TxBuilder.build_tx(
                 wallet_utxos: sample_wallet_utxos(),
                 slot_config: SlotConfig.fetch_slot_config(:preprod)
               )
    end
  end
end
